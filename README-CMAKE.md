# Instructions for building GTFold with ``cmake`` (MacOS and Unix)

The ``cmake`` utility simplifies the build process for GTFold which originally 
used a ``Makefile`` generated by running the ``configure`` script and ``autotools``. 
The core of the ``cmake``-based build process is found in the ``CMakeLists.txt`` 
configuration file in the base directory. This script will build all of the 
utilities using ``g++`` in the ``gtfold-mfe`` directory, e.g., the 
following command line applications: 
``gtmfe``, ``gtboltzmann``, and ``gtsubopt``. 
Documentation for the usage and parameters to each of these 
programs is [found here](http://gtfold.sourceforge.net/guide.html). 

## Prerequisite: Installing ``cmake`` dependencies

### On MacOS (tested on 10.14/Mojave)

Using the Homebrew package manager, run the following command:
```bash
$ brew install gcc@10 libomp cmake
```
If any of the above commands fail due to an existing installation of the 
package, try running the following command instead:
```bash
$ brew upgrade llvm libomp cmake
```
The versions of the ``brew`` packages used for testing are ``libomp`` (**11.0.1**) and 
``cmake`` (**3.19.4**). 
The ``gcc@10`` package is built with the options
```bash
$ g++-10 -v
Using built-in specs.
COLLECT_GCC=g++-10
COLLECT_LTO_WRAPPER=/usr/local/Cellar/gcc/10.2.0_4/libexec/gcc/x86_64-apple-darwin18/10.2.0/lto-wrapper
Target: x86_64-apple-darwin18
Configured with: ../configure --build=x86_64-apple-darwin18 --prefix=/usr/local/Cellar/gcc/10.2.0_4 --libdir=/usr/local/Cellar/gcc/10.2.0_4/lib/gcc/10 --disable-nls --enable-checking=release --enable-languages=c,c++,objc,obj-c++,fortran --program-suffix=-10 --with-gmp=/usr/local/opt/gmp --with-mpfr=/usr/local/opt/mpfr --with-mpc=/usr/local/opt/libmpc --with-isl=/usr/local/opt/isl --with-system-zlib --with-pkgversion='Homebrew GCC 10.2.0_4' --with-bugurl=https://github.com/Homebrew/homebrew-core/issues --disable-multilib --with-native-system-header-dir=/usr/include --with-sysroot=/Library/Developer/CommandLineTools/SDKs/MacOSX10.14.sdk SED=/usr/bin/sed
Thread model: posix
Supported LTO compression algorithms: zlib
gcc version 10.2.0 (Homebrew GCC 10.2.0_4) 
```
It installs a more recent version of the ``clang`` compiler 
toolchain than ships with current MacOS builds. It is necessary to upgrade because 
the default ``gcc`` (symlinked to a dated ``clang`` binary by default) on Mojave/10.14 
is not modern enough to support the C++ standards we require for the GTFold build process.

### On recent Debian Linux variants (including Ubuntu)

Run the following commands to install compiler tools and 
the ``cmake`` utility:
```bash
$ sudo apt-get update && sudo apt-get upgrade
$ sudo apt-get install build-essential cmake
```

## Building GTFold (MFE)

Run the following command at your terminal of choice:
```bash
$ git clone https://github.com/gtDMMB/gtfold.git
$ cd gtfold
$ rm -rf CMakeCache.txt CMakeFiles/
(On MacOS)
$ cmake -v . -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER="/usr/local/Cellar/gcc/10.2.0_4/bin/gcc-10" \
             -DCMAKE_CXX_COMPILER="/usr/local/Cellar/gcc/10.2.0_4/bin/g++-10"
(On Linux/Unix)
$ cmake -v . -DCMAKE_BUILD_TYPE=Release
$ make
```

### Developers: Cleaning the CMake generated files

Run the following command first if the ``CMakeLists.txt`` file has changed since the last 
build/re-compile of GTFold:
```bash
$ rm -rf CMakeCache.txt Makefile cmake_install.cmake CMakeFiles/
```

## Installing the binaries system wide

Run the following commands to put the newly built GTFold 
executables in the system path (from within the base ``gtfold/`` directory):
```bash
$ sudo cp gtfold gtmfe gtboltzmann gtsubopt /usr/local/bin
$ sudo chmod 0644 /usr/local/bin/{gtfold,gtmfe,gtboltzmann,gtsubopt}
```
Alternately, you can configure your local (``bash``) shell to alias these 
commands so that the binaries invoked by running the associated command name 
are linked at the current working directory, e.g., so that running 
``$ gtmfe [options]`` at the command line works directly regardless of the 
actual directory you are located in at runtime.

**(On MacOS):**
```bash
$ export gtfoldCwd="$(greadlink -f .)"
$ echo "alias gtfold='$gtfoldCwd/bin/gtfold'" >> ~/.bash_profile
$ echo "alias gtmfe='$gtfoldCwd/bin/gtmfe'" >> ~/.bash_profile
$ echo "alias gtboltzmann='$gtfoldCwd/bin/gtboltzmann'" >> ~/.bash_profile
$ echo "alias gtsubopt='$gtfoldCwd/bin/gtsubopt'" >> ~/.bash_profile
$ source ~/.bash_profile
```
Note that if ``greadlink`` is not found, you can install it using ``brew`` by running 
```bash
$ brew install greadlink
```
**(On Linux/Unix):**
```bash
$ export gtfoldCwd="$(readlink -f .)"
$ echo "alias gtfold='$gtfoldCwd/bin/gtfold'" >> ~/.bashrc
$ echo "alias gtmfe='$gtfoldCwd/bin/gtmfe'" >> ~/.bashrc
$ echo "alias gtboltzmann='$gtfoldCwd/bin/gtboltzmann'" >> ~/.bashrc
$ echo "alias gtsubopt='$gtfoldCwd/bin/gtsubopt'" >> ~/.bashrc
$ source ~/.bashrc
```
